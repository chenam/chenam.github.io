{"title":"axios 文件下载","date":"2019-04-30T07:23:49.000Z","slug":"axios-文件下载","tags":["小功能"],"categories":["web前端"],"updated":"2020-10-12T06:28:01.117Z","content":"<p>上代码</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">downloadFile(url,params, callback)&#123; <span class=\"comment\">// 下载文件</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> newUrl = params ? <span class=\"keyword\">this</span>.build(url, params) : url</span><br><span class=\"line\">        <span class=\"comment\">// let requestData = Object.assign(&#123;&#125;, data, &#123;</span></span><br><span class=\"line\">        <span class=\"comment\">//     accessToken: sessionStorage.getItem('accessToken')</span></span><br><span class=\"line\">        <span class=\"comment\">//   &#125;);</span></span><br><span class=\"line\">        axios.get(newUrl, &#123;<span class=\"attr\">responseType</span>: <span class=\"string\">'blob'</span>&#125;).then(<span class=\"function\"><span class=\"params\">resp</span> =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> headers = resp.headers;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> contentType = headers[<span class=\"string\">'content-type'</span>];</span><br><span class=\"line\">      </span><br><span class=\"line\">            <span class=\"comment\">// console.log('响应头信息', headers);</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!resp.data) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//   console.error('响应异常：', resp);</span></span><br><span class=\"line\">              <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//   console.error('下载文件：', resp);</span></span><br><span class=\"line\">              <span class=\"keyword\">const</span> blob = <span class=\"keyword\">new</span> Blob([resp.data], &#123;<span class=\"attr\">type</span>: contentType&#125;);</span><br><span class=\"line\">      </span><br><span class=\"line\">              <span class=\"keyword\">const</span> contentDisposition = resp.headers[<span class=\"string\">'content-disposition'</span>];</span><br><span class=\"line\">              <span class=\"keyword\">let</span> fileName = <span class=\"string\">'unknown'</span>;</span><br><span class=\"line\">              <span class=\"keyword\">if</span> (contentDisposition) &#123;</span><br><span class=\"line\">                fileName = <span class=\"built_in\">window</span>.decodeURI(resp.headers[<span class=\"string\">'content-disposition'</span>].split(<span class=\"string\">'='</span>)[<span class=\"number\">1</span>]);</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            <span class=\"comment\">//   console.log('文件名称：', fileName);</span></span><br><span class=\"line\">            <span class=\"comment\">//   callback(blob, fileName)</span></span><br><span class=\"line\">              <span class=\"keyword\">this</span>.downFile(blob, fileName);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;).catch(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">error</span>) </span>&#123;</span><br><span class=\"line\">            <span class=\"built_in\">console</span>.log(error);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    downFile(blob, fileName) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 非IE下载</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"string\">'download'</span> <span class=\"keyword\">in</span> <span class=\"built_in\">document</span>.createElement(<span class=\"string\">'a'</span>)) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">let</span> link = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">'a'</span>);</span><br><span class=\"line\">          link.href = <span class=\"built_in\">window</span>.URL.createObjectURL(blob); <span class=\"comment\">// 创建下载的链接</span></span><br><span class=\"line\">          link.download = fileName; <span class=\"comment\">// 下载后文件名</span></span><br><span class=\"line\">          link.style.display = <span class=\"string\">'none'</span>;</span><br><span class=\"line\">          <span class=\"built_in\">document</span>.body.appendChild(link);</span><br><span class=\"line\">          link.click(); <span class=\"comment\">// 点击下载</span></span><br><span class=\"line\">          <span class=\"built_in\">window</span>.URL.revokeObjectURL(link.href); <span class=\"comment\">// 释放掉blob对象</span></span><br><span class=\"line\">          <span class=\"built_in\">document</span>.body.removeChild(link); <span class=\"comment\">// 下载完成移除元素</span></span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          <span class=\"comment\">// IE10+下载</span></span><br><span class=\"line\">          <span class=\"built_in\">window</span>.navigator.msSaveBlob(blob, fileName);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p><a href=\"https://www.jianshu.com/p/1a867612652c?tdsourcetag=s_pctim_aiomsg\" target=\"_blank\" rel=\"noopener\">参考</a></p>\n","prev":{"title":"2019 月度小结：5月","slug":"2019-月度小结：5月"},"next":{"title":"extends Component 和 无状态组件","slug":"extends-Component-和-无状态组件"},"link":"http://yoursite.com/post/axios-文件下载/"}